{{- if and .Values.stunner.enabled (.Capabilities.APIVersions.Has "gateway.networking.k8s.io/v1") (.Capabilities.APIVersions.Has "stunner.l7mp.io/v1") }}
apiVersion: gateway.networking.k8s.io/v1
kind: GatewayClass
metadata:
  name: stunner-{{ include "openvidu.fullname" . }}-gatewayclass
spec:
  controllerName: "stunner.l7mp.io/gateway-operator"
  parametersRef:
    group: "stunner.l7mp.io"
    kind: GatewayConfig
    name: stunner-{{ include "openvidu.fullname" . }}-gatewayconfig
    namespace: {{ .Release.Namespace }}
  description: "STUNner is a WebRTC ingress gateway for Kubernetes"
---
apiVersion: v1
kind: Secret
metadata:
{{- if .Values.annotations }}
  annotations:
{{ toYaml .Values.annotations | indent 8 }}
{{- end }}
  name: stunner-{{ include "openvidu.fullname" . }}-auth-secret
  labels:
{{ include "openvidu.labels" . | indent 4 }}
type: Opaque
stringData:
  type: static
  username: {{ .Values.stunner.username }}
  password: {{ .Values.stunner.password }}
---
apiVersion: stunner.l7mp.io/v1
kind: GatewayConfig
metadata:
{{- if .Values.annotations }}
  annotations:
{{ toYaml .Values.annotations | indent 8 }}
{{- end }}
  name: stunner-{{ include "openvidu.fullname" . }}-gatewayconfig
  labels:
{{ include "openvidu.labels" . | indent 4 }}
spec:
  logLevel: {{ .Values.stunner.logLevel }}
  realm: {{ .Values.stunner.realm }}
  authRef:
    name: stunner-{{ include "openvidu.fullname" . }}-auth-secret
    namespace: {{ .Release.Namespace }}
---
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
{{- if .Values.stunner.annotations }}
  annotations:
{{ toYaml .Values.stunner.annotations | indent 8 }}
{{- end }}
  name: stunner-{{ include "openvidu.fullname" . }}-server
  labels:
{{ include "openvidu.labels" . | indent 4 }}
spec:
  gatewayClassName: stunner-{{ include "openvidu.fullname" . }}-gatewayclass
  listeners:
    - name: udp-listener
      port: 3478
      protocol: TURN-UDP
      allowedRoutes:
        namespaces:
          from: Same
    - name: dtls-listener
      port: 5349
      protocol: TURN-DTLS
      tls:
        mode: Terminate
        certificateRefs:
          - kind: Secret
            namespace: {{ .Release.Namespace }}
            name: stunner-{{ include "openvidu.fullname" . }}-tls
      allowedRoutes:
        namespaces:
          from: Same
    - name: tcp-listener
      port: 3478
      protocol: TURN-tcp
      allowedRoutes:
        namespaces:
          from: Same
    - name: tls-listener
      port: 5349
      protocol: TURN-TLS
      tls:
        mode: Terminate
        certificateRefs:
          - kind: Secret
            namespace: {{ .Release.Namespace }}
            name: stunner-{{ include "openvidu.fullname" . }}-tls
      allowedRoutes:
        namespaces:
          from: Same
    - name: tls-listener-alt
      port: 443
      protocol: TURN-TLS
      tls:
        mode: Terminate
        certificateRefs:
          - kind: Secret
            namespace: stunner
            name: stunner-{{ include "openvidu.fullname" . }}-tls
      allowedRoutes:
        namespaces:
          from: Same
---
apiVersion: stunner.l7mp.io/v1
kind: UDPRoute
metadata:
{{- if .Values.annotations }}
  annotations:
{{ toYaml .Values.annotations | indent 8 }}
{{- end }}
  name: stunner-{{ include "openvidu.fullname" . }}-server
  labels:
{{ include "openvidu.labels" . | indent 4 }}
spec:
  parentRefs:
    - name: stunner-{{ include "openvidu.fullname" . }}-server
  rules:
    - backendRefs:
        - name: {{ include "openvidu.fullname" . }}
          namespace: {{ .Release.Namespace }}
{{- end }}